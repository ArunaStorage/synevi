syntax = "proto3";

package consensus_transport;

service ConsensusTransport {
  rpc PreAccept(PreAcceptRequest) returns (PreAcceptResponse) {}
  rpc Commit(CommitRequest) returns (CommitResponse) {}
  rpc Accept(AcceptRequest) returns (AcceptResponse) {}
  rpc Apply(ApplyRequest) returns (ApplyResponse) {}
  rpc Recover(RecoverRequest) returns (RecoverResponse) {}
}

message Dependency {
  bytes timestamp = 1;
  bytes timestamp_zero = 2;
}

message PreAcceptRequest {
  bytes event = 1;
  bytes timestamp_zero = 2;
}

message PreAcceptResponse {
  bytes timestamp = 1;
  repeated Dependency dependencies = 2;
}

message AcceptRequest {
  bytes ballot = 1;
  bytes event = 2;
  bytes timestamp_zero = 3;
  bytes timestamp = 4;
  repeated Dependency dependencies = 5;
}

message AcceptResponse {
  repeated Dependency dependencies = 1;
  bool nack = 2;
}

message CommitRequest {
  bytes event = 1;
  bytes timestamp_zero = 2;
  bytes timestamp = 3;
  repeated Dependency dependencies = 4;
}

message CommitResponse {
  // repeated Dependency results = 1; // Theoretically not needed?
}

message ApplyRequest {
  bytes event = 1;
  // This is extra to make it easier to identify the event
  bytes timestamp_zero = 2;
  bytes timestamp = 3;
  repeated Dependency dependencies = 4;
  // bytes result = 5; // Theoretically not needed?
}

message ApplyResponse {}

message RecoverRequest {
  bytes ballot = 1;
  bytes event = 2;
  bytes timestamp_zero = 3;
}

enum State {
  STATE_UNDEFINED = 0;
  STATE_PRE_ACCEPTED = 1;
  STATE_ACCEPTED = 2;
  STATE_COMMITED = 3;
  STATE_APPLIED = 4;
}

message RecoverResponse {
  State local_state = 1;
  repeated Dependency wait = 2;
  repeated Dependency superseding = 3;
  repeated Dependency dependencies = 4;
  bytes timestamp = 5;
  bytes nack = 6;
}
